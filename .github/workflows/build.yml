name: Build GC Server

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ${{ matrix.os }}

    env:
      SCCACHE_GHA_ENABLED: "true"

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        build_type: [Release]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # Linux Dependencies
    - if: matrix.os == 'ubuntu-latest'
      name: Install Linux Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libssl-dev \
          libmariadb-dev \
          libmariadb-dev-compat \
          libcrypto++-dev \
          pkg-config \
          git

    - if: matrix.os != 'windows-latest'
      name: Setup sccache (Linux/Mac)
      uses: mozilla-actions/sccache-action@v0.0.6

    # Linux Build
    - if: matrix.os == 'ubuntu-latest'
      name: Configure CMake (Linux)
      run: |
        mkdir -p ${{ github.workspace }}/build
        mkdir -p ${{ github.workspace }}/release
        cd ${{ github.workspace }}/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                 -DCMAKE_C_COMPILER_LAUNCHER=sccache \
                 -DCMAKE_CXX_COMPILER_LAUNCHER=sccache \
                 -DCRYPTOPP_BUILD_TESTING=OFF \
                 -DCRYPTOPP_INSTALL=OFF
    
    - if: matrix.os == 'ubuntu-latest'
      name: Build (Linux)
      run: |
        cd ${{ github.workspace }}/build
        cmake --build . --config ${{ matrix.build_type }} -j$(nproc)
        
    - if: matrix.os == 'ubuntu-latest'
      name: Package Linux
      run: |
        mkdir -p ${{ github.workspace }}/release/gc_server
        cp ${{ github.workspace }}/build/gc_server/gc_server ${{ github.workspace }}/release/gc_server/
        cp ${{ github.workspace }}/README.md ${{ github.workspace }}/release/ || true
        cp ${{ github.workspace }}/QUICK_START.md ${{ github.workspace }}/release/ || true
        cp -r ${{ github.workspace }}/items ${{ github.workspace }}/release/ || true
        cp ${{ github.workspace }}/start_gc_server.sh ${{ github.workspace }}/release/ || true
        chmod +x ${{ github.workspace }}/release/start_gc_server.sh || true
        chmod +x ${{ github.workspace }}/release/gc_server/gc_server

    # Windows Build
    - if: matrix.os == 'windows-latest'
      name: Build Windows
      run: |
        mkdir ${{ github.workspace }}/build
        mkdir ${{ github.workspace }}/release
        cd ${{ github.workspace }}/build
        cmake .. -G "Visual Studio 17 2022" -A Win32 -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        cmake --build . --config ${{ matrix.build_type }} --parallel

    - if: matrix.os == 'windows-latest'
      name: Package Windows
      shell: bash
      run: |
        mkdir -p ${{ github.workspace }}/release/gc_server
        cp ${{ github.workspace }}/build/gc_server/${{ matrix.build_type }}/gc_server.exe ${{ github.workspace }}/release/gc_server/ || true
        cp ${{ github.workspace }}/README.md ${{ github.workspace }}/release/ || true
        cp ${{ github.workspace }}/QUICK_START.md ${{ github.workspace }}/release/ || true
        cp -r ${{ github.workspace }}/items ${{ github.workspace }}/release/ || true
        cp ${{ github.workspace }}/start_gc_server.bat ${{ github.workspace }}/release/ || true

    # Upload Artifacts
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gc-server-${{ matrix.os }}-${{ matrix.build_type }}
        path: ${{ github.workspace }}/release
        retention-days: 30

    # Create Release on Tag
    - if: startsWith(github.ref, 'refs/tags/')
      name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ github.workspace }}/release/**/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
